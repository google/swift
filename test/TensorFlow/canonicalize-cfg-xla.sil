// RUN: %target-sil-opt -tf-xla-cfg-canonicalize -assume-parsing-unqualified-ownership-sil %s -o /dev/null | %FileCheck %s

import Builtin
import Swift
struct TensorCore<Element> {}

/* This corresponds to this input code:
  var a = <<opaque>>
  a -= a

  for i in 0 ... 100 {
    a += a
    a += a
  }

  a -= a
  print(a, printIt)
*/

// CHECK: --- XLA CFG Canonicalize: testLoop
// CHECK-NEXT: SESESequence {
// CHECK-NEXT:   Block bb0
// CHECK-NEXT:   SESEWhile Header: bb2   exit: bb1
// CHECK-NEXT:     Block bb3
// CHECK-NEXT:   Block bb1
// CHECK-NEXT: }
// CHECK-NEXT: --- XLA CFG Canonicalize end

sil private @testLoop : $@callee_owned (TensorCore<Float>) -> (TensorCore<Float>, TensorCore<Float>) {
// %0                                             // users: %1, %1
bb0(%0 : $TensorCore<Float>):
  %1 = builtin "__tfop_Sub__tt__"(%0 : $TensorCore<Float>, %0 : $TensorCore<Float>) : $TensorCore<Float> // users: %6, %6
  %2 = integer_literal $Builtin.Int64, 0          // user: %3
  %3 = builtin "__tfop_Const__dc__"(%2 : $Builtin.Int64) : $TensorCore<Builtin.Int64> // user: %10
  %4 = integer_literal $Builtin.Int64, 100        // user: %5
  %5 = builtin "__tfop_Const__dc__"(%4 : $Builtin.Int64) : $TensorCore<Builtin.Int64> // user: %17
  %6 = builtin "__tfop_Add__tt__"(%1 : $TensorCore<Float>, %1 : $TensorCore<Float>) : $TensorCore<Float> // users: %7, %7
  %7 = builtin "__tfop_Add__tt__"(%6 : $TensorCore<Float>, %6 : $TensorCore<Float>) : $TensorCore<Float> // user: %10
  %8 = integer_literal $Builtin.Int64, 1          // user: %9
  %9 = builtin "__tfop_Const__dc__"(%8 : $Builtin.Int64) : $TensorCore<Builtin.Int64> // user: %16
  br bb2(%3 : $TensorCore<Builtin.Int64>, %7 : $TensorCore<Float>) // id: %10

bb1:                                              // Preds: bb2
  %11 = builtin "__tfop_Sub__tt__"(%20 : $TensorCore<Float>, %20 : $TensorCore<Float>) : $TensorCore<Float> // user: %12
  %12 = tuple (%20 : $TensorCore<Float>, %11 : $TensorCore<Float>) // user: %13
  return %12 : $(TensorCore<Float>, TensorCore<Float>) // id: %13

// %14                                            // user: %16
// %15                                            // users: %18, %18
bb2(%14 : $TensorCore<Builtin.Int64>, %15 : $TensorCore<Float>): // Preds: bb3 bb0
  %16 = builtin "__tfop_Add__tt__"(%14 : $TensorCore<Builtin.Int64>, %9 : $TensorCore<Builtin.Int64>) : $TensorCore<Builtin.Int64> // users: %23, %17
  %17 = builtin "__tfop_Equal__tt__"(%16 : $TensorCore<Builtin.Int64>, %5 : $TensorCore<Builtin.Int64>) : $TensorCore<Builtin.Int1> // user: %21
  %18 = builtin "__tfop_Add__tt__"(%15 : $TensorCore<Float>, %15 : $TensorCore<Float>) : $TensorCore<Float> // user: %19
  %19 = builtin "tensorflowSend"<TensorCore<Float>>(%18 : $TensorCore<Float>) : $()
  %20 = builtin "tensorflowReceive"<TensorCore<Float>>() : $TensorCore<Float> // users: %12, %23, %11, %11
  %21 = builtin "tf_tensor_to_i1"(%17 : $TensorCore<Builtin.Int1>) : $Builtin.Int1 // user: %22
  cond_br %21, bb1, bb3                           // id: %22

bb3:                                              // Preds: bb2
  br bb2(%16 : $TensorCore<Builtin.Int64>, %20 : $TensorCore<Float>) // id: %23
}


